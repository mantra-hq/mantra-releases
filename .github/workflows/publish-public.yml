name: Publish to Public Repository

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v0.3.0)'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    # 确保变量已在组织或仓库设置中定义
    if: vars.PUBLIC_RELEASE_REPO != ''

    steps:
      - name: Checkout Private Repo
        uses: actions/checkout@v4
        with:
          # 必须获取 tag 历史
          fetch-depth: 0

      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Error: Version must start with 'v' (e.g., v0.3.0)"
            exit 1
          fi

      - name: Download release assets from private repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p release-files
          # 下载私有仓库中对应 tag 的所有附件
          gh release download ${{ inputs.version }} --repo ${{ github.repository }} --dir release-files --pattern '*'
          echo "Downloaded files:"
          ls -la release-files/

      # 【关键修复步】将 Tag 推送到公开仓库，否则创建 Release 会报 404
      - name: Push Tag to Public Repo
        env:
          PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          # 将变量通过 env 传入，避免在 run 中直接使用 {{ }}
          TARGET_REPO: ${{ vars.PUBLIC_RELEASE_REPO }}
        run: |
          # 移除 checkout action 配置的凭据（它会覆盖 URL 中的 token）
          git config --unset-all http.https://github.com/.extraheader || true
          
          # 添加公开仓库作为 remote
          git remote add public "https://x-access-token:${PUBLIC_TOKEN}@github.com/${TARGET_REPO}.git"
          
          echo "Pushing tag ${{ inputs.version }} to ${TARGET_REPO}..."
          git push public "${{ inputs.version }}"

      - name: Create Release in Public Repository
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ vars.PUBLIC_RELEASE_REPO }}
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          tag_name: ${{ inputs.version }}
          name: Mantra ${{ inputs.version }}
          files: release-files/*
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}
          # 2026 建议增加此参数，如果 tag 已存在则不报错
          make_latest: true
          body: |
            ## Mantra ${{ inputs.version }}
            
            ### 下载 / Download
            
            | 平台 / Platform | 文件 / File |
            |-----------------|-------------|
            | **macOS (Apple Silicon)** | `Mantra_*_macos-arm64.dmg` |
            | **macOS (Intel)** | `Mantra_*_macos-x64.dmg` |
            | **Windows** | `.msi` 或 `.exe` |
            | **Linux** | `.AppImage`, `.deb` 或 `.rpm` |

