name: Publish to Public Repository

# æ­¤å·¥ä½œæµç”¨äºå°†å·²å‘å¸ƒçš„ç‰ˆæœ¬åŒæ­¥åˆ°å…¬å¼€ä»“åº“ï¼Œæ— éœ€é‡æ–°æ„å»º
# ä½¿ç”¨åœºæ™¯ï¼š
# 1. ç§æœ‰ä»“åº“å·²æœ‰ Releaseï¼Œä½†å…¬å¼€ä»“åº“å‘å¸ƒå¤±è´¥
# 2. æ‰‹åŠ¨é€‰æ‹©åŒæ­¥æŸä¸ªç‰ˆæœ¬åˆ°å…¬å¼€ä»“åº“

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v0.1.0-alpha.1)'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    if: vars.PUBLIC_RELEASE_REPO != ''

    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Error: Version must start with 'v' followed by semver (e.g., v0.1.0)"
            exit 1
          fi

      - name: Download release assets from private repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p release-files
          
          # è·å– Release ä¿¡æ¯
          RELEASE_INFO=$(gh release view ${{ inputs.version }} --repo ${{ github.repository }} --json assets)
          
          if [ -z "$RELEASE_INFO" ]; then
            echo "Error: Release ${{ inputs.version }} not found in private repo"
            exit 1
          fi
          
          # ä¸‹è½½æ‰€æœ‰èµ„äº§
          gh release download ${{ inputs.version }} --repo ${{ github.repository }} --dir release-files --pattern '*'
          
          echo "Downloaded files:"
          ls -la release-files/

      - name: Create Release in Public Repository
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ vars.PUBLIC_RELEASE_REPO }}
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          tag_name: ${{ inputs.version }}
          name: Mantra ${{ inputs.version }}
          files: release-files/*
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}
          body: |
            ## Mantra ${{ inputs.version }}
            
            ### ä¸‹è½½ / Download
            
            | å¹³å° / Platform | æ–‡ä»¶ / File |
            |-----------------|-------------|
            | **macOS (Apple Silicon)** | `Mantra_*_macos-arm64.dmg` |
            | **macOS (Intel)** | `Mantra_*_macos-x64.dmg` |
            | **Windows** | `.msi` æˆ– `.exe` |
            | **Linux** | `.AppImage` æˆ– `.deb` |
            
            ---
            
            > ğŸ“¦ åŒæ­¥è‡ªç§æœ‰ä»“åº“ / Synced from private repository
