name: Publish to Public Repository

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v0.3.0)'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    # ç¡®ä¿å˜é‡å·²åœ¨ç»„ç»‡æˆ–ä»“åº“è®¾ç½®ä¸­å®šä¹‰
    if: vars.PUBLIC_RELEASE_REPO != ''

    steps:
      - name: Checkout Private Repo
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è·å– tag å†å²
          fetch-depth: 0

      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Error: Version must start with 'v' (e.g., v0.3.0)"
            exit 1
          fi

      - name: Download release assets from private repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p release-files
          # ä¸‹è½½ç§æœ‰ä»“åº“ä¸­å¯¹åº” tag çš„æ‰€æœ‰é™„ä»¶
          gh release download ${{ inputs.version }} --repo ${{ github.repository }} --dir release-files --pattern '*'
          echo "Downloaded files:"
          ls -la release-files/

      # ã€å…³é”®ä¿®å¤æ­¥ã€‘å°† Tag æ¨é€åˆ°å…¬å¼€ä»“åº“ï¼Œå¦åˆ™åˆ›å»º Release ä¼šæŠ¥ 404
      - name: Push Tag to Public Repo
        env:
          PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          # å°†å˜é‡é€šè¿‡ env ä¼ å…¥ï¼Œé¿å…åœ¨ run ä¸­ç›´æ¥ä½¿ç”¨ {{ }}
          TARGET_REPO: ${{ vars.PUBLIC_RELEASE_REPO }}
        run: |
          # ç§»é™¤ checkout action é…ç½®çš„å‡­æ®ï¼ˆå®ƒä¼šè¦†ç›– URL ä¸­çš„ tokenï¼‰
          git config --unset-all http.https://github.com/.extraheader || true
          
          # æ·»åŠ å…¬å¼€ä»“åº“ä½œä¸º remote
          git remote add public "https://x-access-token:${PUBLIC_TOKEN}@github.com/${TARGET_REPO}.git"
          
          echo "Pushing tag ${{ inputs.version }} to ${TARGET_REPO}..."
          git push public "${{ inputs.version }}"

      - name: Generate Release Body
        run: |
          # 1. Create base template with download table
          cat <<EOF > release_body.md
          ## Mantra ${{ inputs.version }}
          
          ### ä¸‹è½½ / Download
          
          | å¹³å° / Platform | æ–‡ä»¶ / File |
          |-----------------|-------------|
          | **macOS (Apple Silicon)** | \`Mantra_*_macos-arm64.dmg\` |
          | **macOS (Intel)** | \`Mantra_*_macos-x64.dmg\` |
          | **Windows** | \`.msi\` æˆ– \`.exe\` |
          | **Linux** | \`.AppImage\`, \`.deb\` æˆ– \`.rpm\` |

          > ğŸ’¡ \`.tar.gz\`, \`.nsis.zip\` åŠ \`.sig\` æ–‡ä»¶ä¸ºè‡ªåŠ¨æ›´æ–°äº§ç‰©ï¼Œæ— éœ€æ‰‹åŠ¨ä¸‹è½½ã€‚
          > \`.tar.gz\`, \`.nsis.zip\` and \`.sig\` files are auto-update artifacts, no manual download needed.
          
          ---
          
          ### æ›´æ–°æ—¥å¿— / Changelog
          
          EOF
          
          # 2. Extract Changelog for the specific version
          VERSION="${{ inputs.version }}"
          CHANGELOG_FILE="CHANGELOG.md"
          
          if [ -f "$CHANGELOG_FILE" ]; then
            echo "Extracting changelog for $VERSION from $CHANGELOG_FILE..."
            # awk logic:
            # 1. Match the version line (e.g., "## [v0.6.0]...") -> set flag=1, skip line
            # 2. If flag is set and we hit the next version line (starts with "## [v") -> exit
            # 3. If flag is set, print the line
            awk -v ver="^## \[${VERSION}\]" '
              $0 ~ ver { flag=1; next } 
              /^## \[v/ && flag { flag=0; exit } 
              flag { print }
            ' "$CHANGELOG_FILE" >> release_body.md
          else
            echo "Warning: CHANGELOG.md not found at $CHANGELOG_FILE"
            echo "No changelog details available." >> release_body.md
          fi
          
          echo "Generated Release Body:"
          cat release_body.md

      - name: Create Release in Public Repository
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ vars.PUBLIC_RELEASE_REPO }}
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          tag_name: ${{ inputs.version }}
          name: Mantra ${{ inputs.version }}
          files: release-files/*
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}
          make_latest: true
          body_path: release_body.md

      - name: Sync CHANGELOG to Public Repo Main
        env:
          PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          TARGET_REPO: ${{ vars.PUBLIC_RELEASE_REPO }}
          USER_EMAIL: ${{ secrets.GIT_USER_EMAIL || 'ci@mantra.app' }}
          USER_NAME: ${{ secrets.GIT_USER_NAME || 'Mantra CI' }}
        run: |
          echo "Syncing CHANGELOG.md to public repository main branch..."
          
          # Clone public repo (depth 1 is enough)
          git clone --depth 1 "https://x-access-token:${PUBLIC_TOKEN}@github.com/${TARGET_REPO}.git" public_repo
          
          # Copy CHANGELOG.md to root of public repo
          cp CHANGELOG.md public_repo/CHANGELOG.md
          
          cd public_repo
          
          # Configure git
          git config user.name "$USER_NAME"
          git config user.email "$USER_EMAIL"
          
          # Check for changes
          if [[ -n $(git status -s) ]]; then
            git add CHANGELOG.md
            git commit -m "docs: update changelog for ${{ inputs.version }}"
            git push origin main
            echo "Successfully pushed CHANGELOG.md updates to main."
          else
            echo "CHANGELOG.md is already up to date."
          fi



